dist: bionic

services:
  - docker

env:
  global:
    - COMMIT_SHA=${TRAVIS_COMMIT::8}

stages:
  - name: "Check"

  # STAGE#1: Build & Test Stage
  # - Enable for master, hotfix, bugfix, release, builds, tests, topic, pull_request, or master-tags (v*, tmp* or qa*)
  - name: "Prepare"
    if: |
      branch = master OR \
      branch =~ /^hotfix\/(.*)/ OR \
      branch =~ /^bugfix\/(.*)/ OR \
      branch =~ /^release\/(.*)/ OR \
      branch =~ /^builds\/(.*)/ OR \
      branch =~ /^tests\/(.*)/ OR \
      branch =~ /^topic\/(.*)/ OR \
      type = pull_request OR \
      ((tag =~ /^(v|tmp|qa)(\d+.)(\d+.)(\d+)$/) AND (branch = master))

  # STAGE#2: Deploy to Prod Stage
  # - Enable for master, or master-tags (only v*)
  - name: "Deploy"
    if: |
      ((branch = master) AND (type != pull_request)) OR \
      ((tag =~ /^(v)(\d+.)(\d+.)(\d+)$/) AND (branch = master) AND (type != pull_request))

jobs:
  include:
    - stage: Check
      script:
        - set -Eeo pipefail
        - chmod 755 ./scripts/envinfo.sh
        - bash ./scripts/envinfo.sh > envinfo.txt
        - cat envinfo.txt

        - echo "Check Condition in Travis Built"
    - stage: Prepare
      script:
        - set -Eeo pipefail
        - chmod 755 ./scripts/envinfo.sh
        - bash ./scripts/envinfo.sh > envinfo.txt
        - cat envinfo.txt

        - echo "~~ Build Success ~~"

    - stage: Deploy
      script:
        - set -Eeo pipefail
        - chmod 755 ./scripts/envinfo.sh
        - bash ./scripts/envinfo.sh > envinfo.txt
        - cat envinfo.txt

        - echo "~~ Deploy Success ~~"
